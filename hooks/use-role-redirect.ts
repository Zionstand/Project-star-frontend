import { useEffect, useRef } from "react";
import { useRouter, usePathname } from "next/navigation";
import api from "@/lib/api";
import { env } from "@/lib/env";
import { useAuth, User } from "@/store/useAuth";
import { useSignout } from "./use-signout";

/** ✅ Hook version (auto-redirect when needed) */
export function useRoleRedirect(user: any) {
  const router = useRouter();
  const pathname = usePathname();
  const handleSignout = useSignout();
  const hasFetchedSchool = useRef(false);

  useEffect(() => {
    if (!user || !user.schoolId) return;

    const path = getDashboardPath(user.role);
    if (!path) return;

    // Only redirect if they're at role root
    const rolePrefix = `/${path.split("/")[1]}`;
    const isAtRoleRoot =
      pathname === "/" ||
      pathname === rolePrefix ||
      pathname === `${rolePrefix}/`;

    if (isAtRoleRoot && pathname !== path) {
      router.replace(path);
    }

    // // Fetch school only once
    // if (!hasFetchedSchool.current) {
    //   hasFetchedSchool.current = true;
    //   api
    //     .get(`${env.NEXT_PUBLIC_BACKEND_URL}/schools/${user.schoolId}`)
    //     .then((res) => {
    //       setSchool(res.data);
    //     })
    //     .catch((err) => {
    //       handleSignout();
    //       console.error("Failed to fetch school:", err);
    //     });
    // }
  }, [user, pathname, router, handleSignout]);
}

/** ✅ Utility version (imperative redirect for logo click, etc.) */
export function getDashboardPath(role: string) {
  const roleRoutes: Record<string, string> = {
    ADMINISTRATOR: "/a/dashboard",
    TEACHER: "/t/dashboard",
    STUDENT: "/s/dashboard",
    PARENT: "/p/dashboard",
    "IT SUPPORT": "/it/dashboard",
    "DATA ANALYST": "/da/dashboard",
    BURSAR: "/b/dashboard",
    "EXAM OFFICER": "/eo/dashboard",
  };

  return roleRoutes[role] ?? "/";
}
